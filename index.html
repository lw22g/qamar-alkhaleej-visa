<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙˆØµÙ„ Ù‚Ø¨Ø¶ - Ù‚Ù…Ø± Ø§Ù„Ø®Ù„ÙŠØ¬</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --royal-green: #1b4d3e;
            --light-green: #f0f5f2;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 12px;
            display: flex;
        }

        /* --- Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ --- */
        .archive-sidebar {
            position: fixed; top: 0; right: -350px; width: 330px; height: 100vh;
            background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: 0.4s; z-index: 2000; display: flex; flex-direction: column;
        }
        .archive-sidebar.open { right: 0; }
        .archive-header { background: var(--royal-green); color: white; padding: 15px; text-align: center; font-weight: bold; }
        .archive-content { flex-grow: 1; overflow-y: auto; padding: 10px; }
        
        .archive-item { 
            background: #fff; border: 1px solid #ddd; margin-bottom: 8px; 
            border-radius: 6px; cursor: pointer; overflow: hidden; border-right: 4px solid var(--royal-green);
        }
        .archive-summary { padding: 10px; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .archive-details { padding: 10px; display: none; border-top: 1px solid #eee; font-size: 13px; background: #fff; line-height: 1.6; }
        .archive-item.active .archive-details { display: block; }
        .btn-del { color: red; cursor: pointer; border: 1px solid red; background: none; padding: 2px 8px; border-radius: 4px; font-size: 11px; }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --- */
        .main-container { flex-grow: 1; transition: 0.4s; }
        .input-form {
            background: white; max-width: 700px; margin: 0 auto 20px auto;
            padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        .input-form h2 { grid-column: span 2; color: var(--royal-green); text-align: center; margin: 0; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 13px; margin-bottom: 3px; color: #555; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: 'Cairo'; }

        .receipt-counter-preview {
            grid-column: span 2; text-align: center; background: #eee;
            padding: 5px; border-radius: 4px; font-weight: bold; color: #d32f2f;
        }

        .names-wrapper { grid-column: span 2; display: flex; flex-direction: column; gap: 8px; border: 1px dashed #ccc; padding: 10px; border-radius: 4px; }
        .name-entry { display: flex; gap: 5px; align-items: center; }
        .btn-add-name { background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 5px 15px; font-weight: bold; }
        .btn-remove-name { background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 5px 10px; }

        .submit-btn {
            grid-column: span 2; background-color: var(--royal-green); color: white;
            padding: 12px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; font-family: 'Cairo'; font-weight: bold; margin-top: 10px;
        }

        .btn-toggle-archive { position: fixed; top: 20px; left: 20px; background: var(--royal-green); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; z-index: 1001; }

        /* --- ØªÙ†Ø³ÙŠÙ‚ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© --- */
        #print-area {
            display: none; flex-direction: column;
            width: 210mm; height: 297mm; margin: 0 auto; background: white;
        }

        .receipt-instance {
            height: 50%; box-sizing: border-box; padding: 15px 30px; 
            border: 2px solid var(--royal-green); display: flex;
            flex-direction: column; position: relative; overflow: hidden;
        }

        .receipt-instance:first-child { border-bottom: 1px dashed #aaa; }

        .receipt-logo {
            position: absolute; top: 15px; right: 30px;
            width: 80px; height: auto; object-fit: contain;
        }

        .receipt-no {
            position: absolute; top: 15px; left: 30px;
            border: 1px solid var(--royal-green); padding: 2px 10px; border-radius: 4px;
            color: var(--royal-green); font-weight: bold; font-size: 13px;
        }

        .company-details { text-align: center; color: var(--royal-green); margin-bottom: 5px; }
        .company-details h1 { margin: 0; font-size: 32px; font-weight: 900; }
        .company-details p { margin: 0; font-size: 16px; }

        .receipt-title {
            text-align: center; background: var(--royal-green); color: white;
            padding: 3px; margin: 6px 0; font-size: 18px; border-radius: 20px;
        }

        .names-display-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px 15px;
            border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 8px;
        }
        .name-tag { font-size: 14px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .name-label { color: var(--royal-green); font-weight: bold; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .info-item { font-size: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 2px; display: flex; align-items: center; }
        .info-label { font-weight: bold; color: var(--royal-green); min-width: 110px; }
        .info-value { color: #333; }
        .full-width { grid-column: span 2; }
        .highlight-date { color: #d32f2f; font-weight: bold; }

        .notes-section {
            padding: 8px 12px; border: 1px solid var(--royal-green);
            background-color: var(--light-green); border-radius: 6px; margin-bottom: 10px;
        }
        .notes-list { list-style: none; padding: 0; margin: 0; font-size: 11px; line-height: 1.4; }
        .notes-list li { 
            margin-bottom: 2px; padding-right: 15px; position: relative; 
            font-weight: bold; color: #1b4d3e;
        }
        .notes-list li::before { content: "â€¢"; color: var(--royal-green); position: absolute; right: 0; }

        .contact-info-footer {
            border-top: 1.5px solid var(--royal-green); padding-top: 5px; text-align: center;
            color: var(--royal-green); margin-top: auto; font-size: 12px; font-weight: bold;
        }

        /* --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª --- */
        .notify-box {
            position: fixed; bottom: 20px; right: -350px; width: 300px;
            background: white; border-right: 5px solid #d32f2f;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-radius: 8px;
            transition: right 0.5s ease-in-out; z-index: 3000;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .notify-box.show { right: 20px; }
        .notify-header {
            background: #d32f2f; color: white; padding: 10px;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; font-size: 14px;
        }
        .notify-content { max-height: 200px; overflow-y: auto; padding: 10px; }
        .notify-item {
            border-bottom: 1px solid #eee; padding: 8px 0; font-size: 13px; line-height: 1.5;
        }
        .notify-item:last-child { border-bottom: none; }
        .notify-item span { color: #d32f2f; font-weight: bold; }

        @media print {
            @page { size: A4; margin: 0; }
            body { padding: 0; background: white; display: block; }
            .main-container, .archive-sidebar, .btn-toggle-archive, .notify-box { display: none !important; }
            #print-area { display: flex !important; width: 100%; height: 100vh; }
        }
    </style>
</head>
<body>

    <button class="btn-toggle-archive" onclick="toggleSidebar()"> Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>

    <div class="archive-sidebar" id="sidebar">
        <div class="archive-header">Ø£Ø±Ø´ÙŠÙ Ø§Ù„ÙˆØ§ØµÙ„Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</div>
        <div class="archive-content" id="archive-list"></div>
        <button onclick="toggleSidebar()" style="padding:10px; cursor:pointer; width:100%; border:none; background:#eee;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div id="visa-notifications" class="notify-box" dir="rtl">
        <div class="notify-header">
            <span>ğŸ”” ØªÙ†Ø¨ÙŠÙ‡: ÙÙŠØ² Ù…Ø³ØªØ­Ù‚Ø© Ø§Ù„ÙŠÙˆÙ…</span>
            <button onclick="closeNotifications()" style="background:none; border:none; color:white; cursor:pointer; font-size:16px;">âœ–</button>
        </div>
        <div id="notify-list" class="notify-content"></div>
    </div>

    <div class="main-container">
        <div class="input-form">
            <h2>Ø¥ØµØ¯Ø§Ø± ÙˆØµÙ„ Ø¬Ø¯ÙŠØ¯</h2>
            <div class="receipt-counter-preview">Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„ Ø§Ù„Ù‚Ø§Ø¯Ù…: <span id="next-id-view">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div>
            
            <div class="names-wrapper" id="names-container">
                <label>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§ÙØ±ÙŠÙ†</label>
                <div class="name-entry">
                    <input type="text" class="in-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§ÙØ±" style="flex-grow: 1;">
                    <button type="button" class="btn-add-name" onclick="addNewNameField()">Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù… +</button>
                </div>
            </div>

            <div class="input-group"><label>Ø¨Ù„Ø¯ Ø§Ù„ØªØ£Ø´ÙŠØ±Ø©</label><input type="text" id="in-country" placeholder=""></div>
            <div class="input-group"><label>Ù…Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</label><input type="number" id="in-duration"></div>
            <div class="input-group"><label>Ù†ÙˆØ¹ Ø§Ù„ØªØ£Ø´ÙŠØ±Ø©</label><input type="text" id="in-visaType"></div>
            <div class="input-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</label><input type="date" id="in-date"></div>
            <div class="input-group"><label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙˆØ§ØµÙ„</label><input type="text" id="in-paid" onblur="formatPrice(this)"></div>
            <div class="input-group"><label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¨Ø§Ù‚ÙŠ</label><input type="text" id="in-remain" onblur="formatPrice(this)"></div>
            <div class="input-group full-width"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="in-phone"></div>
            
            <button class="submit-btn" id="btn-submit" onclick="processAndPrint()" disabled>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨...</button>
            <button onclick="resetCounter()" style="background:none; border:none; color:gray; cursor:pointer; font-size:10px; grid-column: span 2;">ØªØµÙÙŠØ± Ø§Ù„ØªØ³Ù„Ø³Ù„</button>
        </div>
    </div>

    <div id="print-area">
        <div class="receipt-instance" id="receipt-customer">
            <img src="logo.png" class="receipt-logo" alt="Logo">
            <div class="receipt-no">No: <span class="out-receipt-id">0000</span></div>
            <div class="company-details"><h1>Ø´Ø±ÙƒØ© Ù‚Ù…Ø± Ø§Ù„Ø®Ù„ÙŠØ¬</h1><p>Ù„Ù„Ø³ÙØ± ÙˆØ§Ù„Ø³ÙŠØ§Ø­Ø©</p></div>
            <div class="receipt-title">ÙˆØµÙ„ Ø§Ø³ØªÙ„Ø§Ù… ÙˆØªØ¹Ù‡Ø¯ (Ù†Ø³Ø®Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†)</div>
            <div class="names-display-container out-names"></div>
            <div class="info-grid out-details"></div>
            <div class="notes-section">
                <ul class="notes-list" id="notes-customer"></ul>
            </div>
            <div class="contact-info-footer">Ø§Ù„ÙÙ„ÙˆØ¬Ø© - Ø´Ø§Ø±Ø¹ Ø§Ù„Ø«Ø±Ø«Ø§Ø± -   07844005572 | 07744005595 | 07500807094</div>
        </div>

        <div class="receipt-instance" id="receipt-office">
            <img src="logo.png" class="receipt-logo" alt="Logo">
            <div class="receipt-no">No: <span class="out-receipt-id">0000</span></div>
            <div class="company-details"><h1>Ø´Ø±ÙƒØ© Ù‚Ù…Ø± Ø§Ù„Ø®Ù„ÙŠØ¬</h1><p>Ù„Ù„Ø³ÙØ± ÙˆØ§Ù„Ø³ÙŠØ§Ø­Ø©</p></div>
            <div class="receipt-title">ÙˆØµÙ„ Ø§Ø³ØªÙ„Ø§Ù… ÙˆØªØ¹Ù‡Ø¯ (Ù†Ø³Ø®Ø© Ø§Ù„Ù…ÙƒØªØ¨)</div>
            <div class="names-display-container out-names"></div>
            <div class="info-grid out-details"></div>
            <div class="contact-info-footer">Ø§Ù„ÙÙ„ÙˆØ¬Ø© - Ø´Ø§Ø±Ø¹ Ø§Ù„Ø«Ø±Ø«Ø§Ø± - 07844005572 | 07744005595</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, query, orderBy, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCaBLp_vqvzg6k0TLiKUkqDTMW5hh3zyyY",
            authDomain: "qamar-visa.firebaseapp.com",
            databaseURL: "https://qamar-visa-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "qamar-visa",
            storageBucket: "qamar-visa.firebasestorage.app",
            messagingSenderId: "157247216623",
            appId: "1:157247216623:web:63a085a72e25078131341a",
            measurementId: "G-6NY0MK1MN2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const receiptsCol = collection(db, "receipts");
        const settingsDoc = doc(db, "settings", "counters");
        
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyN5FyUeae3ugbupejyOdmAWhWprjFiEw_Bioilpo9sfLn9FOhTv19-RpOyUvWfNGx4Dw/exec';

        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
        
        window.closeNotifications = () => {
            document.getElementById('visa-notifications').classList.remove('show');
        };

        const formatID = (num) => String(num).padStart(4, '0');

        window.formatPrice = (input) => {
            let val = input.value.replace(/,/g, '');
            if (val !== "" && !isNaN(val)) {
                let numericVal = parseFloat(val);
                if (numericVal < 10000 && numericVal > 0) numericVal = numericVal * 1000;
                input.value = numericVal.toLocaleString();
            }
        };

        async function getNextSerial() {
            const snap = await getDoc(settingsDoc);
            return snap.exists() ? snap.data().lastSerial + 1 : 1;
        }

        function checkNotifications(data) {
            let d = new Date();
            let todayStr = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
            
            let dueToday = data.filter(item => item.expected === todayStr);
            let notifyBox = document.getElementById('visa-notifications');
            let notifyList = document.getElementById('notify-list');
            
            if (dueToday.length > 0) {
                notifyList.innerHTML = dueToday.map(item => `
                    <div class="notify-item">
                        <span>ÙˆØµÙ„ Ø±Ù‚Ù…: ${item.id}</span><br>
                        <b>Ø§Ù„Ø§Ø³Ù…:</b> ${item.names[0]} ${item.names.length > 1 ? '(ÙˆÙ…Ø±Ø§ÙÙ‚ÙŠÙ‡)' : ''}<br>
                        <b>Ø§Ù„Ø¨Ù„Ø¯:</b> ${item.country} | <b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${item.phone}
                    </div>
                `).join('');
                
                setTimeout(() => notifyBox.classList.add('show'), 1500);
            } else {
                notifyBox.classList.remove('show');
            }
        }

        window.onload = async () => {
            document.getElementById('in-date').value = new Date().toISOString().split('T')[0];
            try {
                const nextID = await getNextSerial();
                document.getElementById('next-id-view').innerText = formatID(nextID);
                document.getElementById('btn-submit').disabled = false;
                document.getElementById('btn-submit').innerText = "ØªÙˆÙ„ÙŠØ¯ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„";
            } catch (e) {
                document.getElementById('next-id-view').innerText = "Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„";
            }

            const q = query(receiptsCol, orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const receiptsData = snapshot.docs.map(d => ({ docId: d.id, ...d.data() }));
                renderArchive(receiptsData);
                checkNotifications(receiptsData); 
            });
        };

        window.addNewNameField = () => {
            const container = document.getElementById('names-container');
            const div = document.createElement('div');
            div.className = 'name-entry';
            div.innerHTML = `<input type="text" class="in-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§ÙØ±" style="flex-grow: 1;"><button type="button" class="btn-remove-name" onclick="this.parentElement.remove()">Ø­Ø°Ù Ã—</button>`;
            container.appendChild(div);
        };

        function calculateWorkDays(startDateStr, duration) {
            if (!startDateStr || !duration) return "Ø³ÙŠØªÙ… Ø¥Ø¨Ù„Ø§ØºÙƒÙ… Ù„Ø§Ø­Ù‚Ø§Ù‹";
            let date = new Date(startDateStr);
            let added = 0;
            while (added < parseInt(duration)) {
                date.setDate(date.getDate() + 1);
                if (date.getDay() !== 5 && date.getDay() !== 6) added++;
            }
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
        }

        window.processAndPrint = async () => {
            const country = document.getElementById('in-country').value.trim();
            const names = Array.from(document.querySelectorAll('.in-name')).map(i => i.value).filter(v => v.trim() !== "");
            if(names.length === 0) return alert("Ù„Ø·ÙØ§Ù‹ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø³Ø§ÙØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");

            const btn = document.getElementById('btn-submit');
            btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

            const currentSerial = await getNextSerial();
            const formattedID = formatID(currentSerial);
            const dateVal = document.getElementById('in-date').value;
            const duration = document.getElementById('in-duration').value;
            const expected = calculateWorkDays(dateVal, duration);

            const receiptData = {
                id: formattedID, names, country,
                visaType: document.getElementById('in-visaType').value,
                date: dateVal ? dateVal.split('-').reverse().join('/') : '',
                paid: document.getElementById('in-paid').value,
                remain: document.getElementById('in-remain').value,
                phone: document.getElementById('in-phone').value,
                expected, timestamp: new Date()
            };

            try {
                await addDoc(receiptsCol, receiptData);
                await setDoc(settingsDoc, { lastSerial: currentSerial }, { merge: true });

                fetch(scriptURL, {
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        names: names.join(' - '), country: receiptData.country,
                        phone: receiptData.phone, date: receiptData.date,
                        expected: receiptData.expected, paid: receiptData.paid, remain: receiptData.remain
                    })
                });

                let notesHtml = `
                    <li>ÙŠÙˆÙ… Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… ÙˆØ§ÙŠØ§Ù… Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© ØºÙŠØ± Ù…Ø­ØªØ³Ø¨Ø© Ù…Ù† Ø¶Ù…Ù† Ø§ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„.</li>
                    <li>Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± Ù…Ø³ØªØ±Ø¬Ø¹ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¶.</li>
                    <li>Ù„Ø§ ØªØªØ­Ù…Ù„ Ø§Ù„Ø´Ø±ÙƒØ© Ø§ÙŠ ØªØ£Ø®ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø§Ù…Ù†ÙŠ Ù„Ù„Ø´Ø®Øµ Ø§Ù†Ù…Ø§ ØªÙ„ØªØ²Ù… ÙˆÙÙ‚ Ø§Ù„Ø¶ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø¹Ù…ÙˆÙ„ Ø¨Ù‡Ø§.</li>
                `;
                if (country.includes("Ù…ØµØ±")) {
                    notesHtml += `
                        <li>ÙŠØ¬Ø¨ Ø§Ø¨Ù„Ø§ØºÙ†Ø§ Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³ÙØ± Ù‚Ø¨Ù„ ÙŠÙˆÙ…ÙŠÙ† Ù„Ø¹Ù…Ù„ ÙˆØ±Ù‚Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„.</li>
                        <li>Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³ÙØ± Ù„Ù…ØµØ± Ù…Ù† Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¹Ø±Ø§Ù‚ ÙŠØ¬Ø¨ Ø§Ø¨Ù„Ø§ØºÙ†Ø§ Ù‚Ø¨Ù„ Ø£Ø³Ø¨ÙˆØ¹.</li>
                        <li>ÙŠÙØ¯ÙØ¹ Ù…Ø¨Ù„Øº 25 $ Ø±Ø³ÙˆÙ… Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Ù…Ø·Ø§Ø± Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©.</li>
                        <li>ÙÙŠ Ø­Ø§Ù„ Ù‚Ø·Ø¹ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…Ù† Ø®Ø§Ø±Ø¬ Ù…ÙƒØªØ¨Ù†Ø§ ÙŠÙƒÙˆÙ† Ø³Ø¹Ø± Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ 25,000 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±.</li>
                    `;
                }
                document.getElementById('notes-customer').innerHTML = notesHtml;

                document.querySelectorAll('.out-receipt-id').forEach(el => el.innerText = formattedID);
                let nHtml = names.map((n, i) => `<div class="name-tag"><span class="name-label">(${i+1})</span> ${n}</div>`).join('');
                document.querySelectorAll('.out-names').forEach(el => el.innerHTML = nHtml);

                const fields = (incExp) => `
                    <div class="info-item"><span class="info-label">Ø¨Ù„Ø¯ Ø§Ù„ØªØ£Ø´ÙŠØ±Ø©:</span> <span class="info-value">${country}</span></div>
                    <div class="info-item"><span class="info-label">Ù…Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„:</span> <span class="info-value">${duration ? duration + ' Ø£ÙŠØ§Ù… Ø¹Ù…Ù„' : ''}</span></div>
                    <div class="info-item"><span class="info-label">Ù†ÙˆØ¹ Ø§Ù„ØªØ£Ø´ÙŠØ±Ø©:</span> <span class="info-value">${receiptData.visaType}</span></div>
                    <div class="info-item"><span class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…:</span> <span class="info-value">${receiptData.date}</span></div>
                    <div class="info-item"><span class="info-label">Ø§Ù„ÙˆØ§ØµÙ„:</span> <span class="info-value">${receiptData.paid}</span></div>
                    <div class="info-item"><span class="info-label">Ø§Ù„Ø¨Ø§Ù‚ÙŠ:</span> <span class="info-value">${receiptData.remain}</span></div>
                    <div class="info-item full-width"><span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span> <span class="info-value">${receiptData.phone}</span></div>
                    ${incExp ? `<div class="info-item full-width"><span class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</span> <span class="info-value highlight-date">${expected}</span></div>` : ''}
                `;
                document.querySelector('#receipt-customer .out-details').innerHTML = fields(false);
                document.querySelector('#receipt-office .out-details').innerHTML = fields(true);

                window.print();
                btn.disabled = false; btn.innerText = "ØªÙˆÙ„ÙŠØ¯ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„";
                document.getElementById('next-id-view').innerText = formatID(currentSerial + 1);
            } catch (e) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
                btn.disabled = false;
            }
        };

        function renderArchive(data) {
            const list = document.getElementById('archive-list');
            list.innerHTML = data.map(item => `
                <div class="archive-item">
                    <div class="archive-summary" onclick="this.parentElement.classList.toggle('active')">
                        <span><b>#${item.id}</b> - ${item.names[0]}</span>
                        <button class="btn-del" onclick="deleteReceipt('${item.docId}')">Ø­Ø°Ù</button>
                    </div>
                    <div class="archive-details">
                        <b>Ø§Ù„Ù…Ø³Ø§ÙØ±ÙŠÙ†:</b> ${item.names.join(' , ')}<br>
                        <b>Ø§Ù„Ø¨Ù„Ø¯:</b> ${item.country} | <b>Ø§Ù„ÙˆØ§ØµÙ„:</b> ${item.paid}
                    </div>
                </div>
            `).join('');
        }

        window.deleteReceipt = async (id) => { if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) await deleteDoc(doc(db, "receipts", id)); };
        window.resetCounter = async () => { if(confirm("ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŸ")) { await setDoc(settingsDoc, { lastSerial: 0 }); location.reload(); }};
    </script>
</body>
</html>